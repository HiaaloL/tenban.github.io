<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Racing Endless 3D</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>
<style>
html,body{margin:0;overflow:hidden;background:black;font-family:sans-serif}
#hud{position:fixed;top:10px;left:10px;color:white;z-index:5}
#hpbar{width:120px;height:10px;background:#400;margin-top:4px}
#hp{height:100%;background:#f00}
#controls{position:fixed;bottom:10px;width:100%;display:flex;justify-content:space-around;z-index:5}
#controls button{width:60px;height:60px;border-radius:50%;font-size:22px}

/* Tutorial */
#tutorial{
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 20px 30px;
  font-size: 18px;
  border-radius: 10px;
  text-align: center;
  z-index: 10;
  transition: opacity 0.5s ease; /* fade mượt */
}
#tutorial.hidden{
  opacity: 0;
  pointer-events: none;
}
</style>
</head>
<body>

<div id="hud">
 <div id="speed">0 km/h</div>
 <div id="nitro">Nitro: 100%</div>
 <div id="score">Score: 0</div>
 <div id="high">High: 0</div>
 <div id="hpbar"><div id="hp"></div></div>
</div>

<!-- Tutorial -->
<div id="tutorial">
  <p>Điều khiển xe:</p>
  <p>◀/▶: Trái/Phải</p>
  <p>⛽: Tăng tốc</p>
  <p>⚡: Nitro</p>
  <p>Bấm ⟳ để khởi động lại</p>
</div>

<div id="controls">
 <button ontouchstart="left=true" ontouchend="left=false">◀</button>
 <button ontouchstart="right=true" ontouchend="right=false">▶</button>
 <button ontouchstart="gas=true" ontouchend="gas=false">⛽</button>
 <button ontouchstart="nitro=true" ontouchend="nitro=false">⚡</button>
 <button onclick="restartGame()">⟳</button>
</div>

<script>
/* ===== SCENE ===== */
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x87ceeb,0.002);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
camera.position.set(0,5,-9);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

/* ===== SKY ===== */
const sky = new THREE.Mesh(
 new THREE.SphereGeometry(500,32,32),
 new THREE.MeshBasicMaterial({color:0x87ceeb, side:THREE.BackSide})
);
scene.add(sky);

/* ===== LIGHT ===== */
const sun = new THREE.DirectionalLight(0xffffff,1.4);
sun.position.set(60,100,40);
scene.add(sun);

/* ===== ROAD ===== */
const roadWidth = 22;
const road = new THREE.Mesh(
 new THREE.PlaneGeometry(roadWidth,20000),
 new THREE.MeshStandardMaterial({color:0x333333})
);
road.rotation.x = -Math.PI/2;
scene.add(road);

/* ===== BORDERS ===== */
const borderGroup = new THREE.Group();
scene.add(borderGroup);
function createBorder(x){
 const b = new THREE.Mesh(
  new THREE.BoxGeometry(0.4,1.2,20000),
  new THREE.MeshStandardMaterial({
   color:0xffffff,
   emissive:0x222222,
   emissiveIntensity:1
  })
 );
 b.position.set(x,0.6,10000);
 borderGroup.add(b);
}
const borderOffset = roadWidth/2 + 0.2;
createBorder(-borderOffset);
createBorder(borderOffset);

/* ===== CAR MODEL ===== */
function buildCar(color){
 const g = new THREE.Group();
 const body = new THREE.Mesh(
  new THREE.BoxGeometry(1.3,0.4,2.6),
  new THREE.MeshStandardMaterial({color,metalness:0.6,roughness:0.4})
 );
 body.position.y = 0.35; g.add(body);

 const cabin = new THREE.Mesh(
  new THREE.BoxGeometry(0.9,0.35,1.3),
  new THREE.MeshStandardMaterial({color:color*0.8})
 );
 cabin.position.set(0,0.7,-0.2); g.add(cabin);

 function wheel(x,z){
  const w = new THREE.Mesh(
   new THREE.CylinderGeometry(0.25,0.25,0.3,16),
   new THREE.MeshStandardMaterial({color:0x111})
  );
  w.rotation.z = Math.PI/2;
  w.position.set(x,0.15,z);
  g.add(w);
 }
 wheel(-0.65,1); wheel(0.65,1);
 wheel(-0.65,-1); wheel(0.65,-1);

 return g;
}

/* ===== PLAYER ===== */
const car = buildCar(0xff0000);
scene.add(car);

/* ===== HEAD LIGHT ===== */
const headLight = new THREE.SpotLight(0xffffff,3,55,Math.PI/6,0.4);
headLight.position.set(0,0.7,1.8);
headLight.target.position.set(0,0.5,10);
car.add(headLight);
car.add(headLight.target);

/* ===== AI ===== */
let aiCars=[];
const AI_COUNT=40;
const AI_SPACING=30;
function spawnAI(z){
 const ai = buildCar(0x0066ff);
 ai.position.set(
  Math.random()*(roadWidth-4)-(roadWidth/2-2),
  0,
  z
 );
 scene.add(ai);
 aiCars.push(ai);
}
function resetAI(){
 aiCars.forEach(a=>scene.remove(a));
 aiCars=[];
 for(let i=0;i<AI_COUNT;i++) spawnAI(60+i*AI_SPACING);
}
resetAI();

/* ===== EFFECTS ===== */
const explosions=[];
function explode(pos){
 for(let i=0;i<30;i++){
  const p = new THREE.Mesh(
   new THREE.SphereGeometry(0.1,6,6),
   new THREE.MeshStandardMaterial({color:0xff8800,transparent:true})
  );
  p.position.copy(pos);
  p.vel = new THREE.Vector3(
   (Math.random()-0.5)*0.4,
   Math.random()*0.4,
   (Math.random()-0.5)*0.4
  );
  scene.add(p);
  explosions.push(p);
 }
}

/* ===== GAME VAR ===== */
let speed = 0;
let steerV = 0;
let left=false,right=false,gas=false,nitro=false;
let nitroEnergy = 1;
let score = 0;
let highScore = localStorage.getItem("highScore")||0;
let hp = 100;
let lastZ = 0;
let isDay = true;

/* ===== INPUT ===== */
addEventListener("keydown", e=>{
 if(e.key=="a") left=true;
 if(e.key=="d") right=true;
 if(e.key=="w") gas=true;
 if(e.key==" ") nitro=true;
});
addEventListener("keyup", e=>{
 if(e.key=="a") left=false;
 if(e.key=="d") right=false;
 if(e.key=="w") gas=false;
 if(e.key==" ") nitro=false;
});

/* ===== RESTART ===== */
function restartGame(){
 car.position.set(0,0,0);
 speed=0; steerV=0;
 score=0; hp=100;
 nitroEnergy=1; lastZ=0;
 resetAI();
 document.getElementById("tutorial").classList.remove("hidden"); // hiển thị lại hướng dẫn
}

/* ===== DAY NIGHT MƯỢT MÀ ===== */
let dayNightProgress = 0; // 0=ngày, 1=đêm
let targetDayNight = 0;   // mục tiêu (0=ngày, 1=đêm)
function updateDayNight(){
    const mode = Math.floor(score/2000)%2;
    targetDayNight = mode===0 ? 0 : 1;

    const lerpSpeed = 0.01;
    dayNightProgress += (targetDayNight - dayNightProgress)*lerpSpeed;

    sun.intensity = 1.4*(1-dayNightProgress) + 0.3*dayNightProgress;

    const dayColor = new THREE.Color(0x87ceeb);
    const nightColor = new THREE.Color(0x02030a);
    sky.material.color.lerpColors(dayColor, nightColor, dayNightProgress);
    renderer.setClearColor(sky.material.color);

    headLight.intensity = 3 * dayNightProgress;

    borderGroup.children.forEach(b=>{
        b.material.emissive.setHex(dayNightProgress < 0.5 ? 0x222222 : 0x00ffff);
    });

    isDay = dayNightProgress < 0.5;
}

/* ===== STARS ===== */
const stars = [];
for(let i=0;i<200;i++){
 const s = new THREE.Mesh(
  new THREE.SphereGeometry(0.07,4,4),
  new THREE.MeshBasicMaterial({color:0xffffff})
 );
 s.position.set((Math.random()-0.5)*500, Math.random()*50+20, (Math.random()-0.5)*500);
 s.visible = false;
 scene.add(s);
 stars.push(s);
}

/* ===== TUTORIAL ===== */
const tutorial = document.getElementById("tutorial");

/* ===== LOOP ===== */
function animate(){
 requestAnimationFrame(animate);

 updateDayNight();
 stars.forEach(s=>s.visible = !isDay);

 // Ẩn hướng dẫn khi xe bắt đầu chạy
 if(!tutorial.classList.contains("hidden") && (speed > 0 || gas)){
     tutorial.classList.add("hidden");
 }

 /* SPEED */
 const maxSpeed = 0.32;
 if(gas) speed = Math.min(speed+0.004,maxSpeed);
 if(nitro && nitroEnergy>0){ speed = Math.min(speed+0.008,maxSpeed); nitroEnergy -= 0.008; }
 speed *= 0.985;
 car.position.z += speed*6;

 /* NITRO REGEN */
 const dz = car.position.z - lastZ;
 if(dz>0){ nitroEnergy = Math.min(1, nitroEnergy + dz*0.00025); lastZ = car.position.z; }

 /* STEER */
 const steerForce = 0.02;
 if(left) steerV += steerForce;
 if(right) steerV -= steerForce;
 steerV *= 0.9;
 car.position.x += steerV;
 car.position.x = Math.max(-roadWidth/2+1, Math.min(roadWidth/2-1, car.position.x));

 /* BORDER HIT */
 if(Math.abs(car.position.x) >= roadWidth/2-1){ hp-=2; speed*=0.85; }

 /* AI */
 aiCars.forEach(ai=>{
    if(ai.position.z < car.position.z-10){
      ai.position.z = car.position.z + AI_COUNT*AI_SPACING;
      ai.position.x = Math.random()*(roadWidth-4) - (roadWidth/2-2);
    }
    if(ai.position.distanceTo(car.position) < 1.5){
      explode(ai.position); ai.position.z = car.position.z + AI_COUNT*AI_SPACING;
      hp -= 4; speed *= 0.85;
    }
 });

 /* EXPLOSION */
 explosions.forEach((p,i)=>{ 
    p.position.add(p.vel); 
    p.material.opacity -= 0.03;
    if(p.material.opacity <= 0){ scene.remove(p); explosions.splice(i,1); }
 });

 /* RESPAWN */
 if(hp <= 0){
    explode(car.position);
    car.position.set(0,0,0);
    speed = 0; steerV = 0;
    nitroEnergy = 0.3;
    hp = 100;
    score = 0;
    resetAI();
    tutorial.classList.remove("hidden"); // hiển thị lại hướng dẫn
 }

 /* SCORE */
 score += Math.floor(speed*10);
 if(score > highScore){ highScore = score; localStorage.setItem("highScore",highScore); }

 /* HUD */
 document.getElementById("speed").innerText = Math.floor(speed*300)+" km/h";
 document.getElementById("nitro").innerText = "Nitro: "+Math.floor(nitroEnergy*100)+"%";
 document.getElementById("score").innerText = "Score: "+score;
 document.getElementById("high").innerText = "High: "+highScore;
 document.getElementById("hp").style.width = hp+"%";

 /* CAMERA */
 camera.position.x += (car.position.x - camera.position.x)*0.1;
 camera.position.z = car.position.z - 9;
 camera.lookAt(car.position.x,1,car.position.z+5);

 renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>